import streamlit as st
import streamlit.components.v1 as components
from urllib.parse import urlparse
from bs4 import BeautifulSoup
import fdds
import requests
import random



user_agents = [
    'Mozilla/5.0 (Windows NT 10.0; Win64; x64) AppleWebKit/537.36 (KHTML, like Gecko) Chrome/120.0.0.0 Safari/537.36',
    'Mozilla/5.0 (Macintosh; Intel Mac OS X 10_15_7) AppleWebKit/537.36 (KHTML, like Gecko) Chrome/120.0.0.0 Safari/537.36',
    'Mozilla/5.0 (Windows NT 10.0; Win64; x64; rv:121.0) Gecko/20100101 Firefox/121.0',
    'Mozilla/5.0 (Macintosh; Intel Mac OS X 10_15_7) AppleWebKit/605.1.15 (KHTML, like Gecko) Version/17.1 Safari/605.1.15',
    'Mozilla/5.0 (X11; Linux x86_64) AppleWebKit/537.36 (KHTML, like Gecko) Chrome/120.0.0.0 Safari/537.36'
]


def scrape_page(url):
    headers = {
        'User-Agent': random.choice(user_agents)
    }
    session = requests.Session()
    session.headers.update(headers)
    response = session.get(url)

    return response.text


st.set_page_config(page_title="News Scraper", layout="wide")

st.title("ðŸ“° News Scraper Dashboard")

url = st.text_input("Enter News Article URL")


def id(url):
    """
    Detect Indian news source from article URL
    Returns: 'indiatoday', 'hindustantimes', 'zeenews', 'livemint', 'timesofindia' or None
    """
    domain = urlparse(url).netloc.lower()

    if "indiatoday.in" in domain:
        return 1

    if "hindustantimes.com" in domain:
        return 2

    if "zeenews.india.com" in domain or "zeenews.com" in domain:
        return 3

    if "livemint.com" in domain:
        return 4

    if "timesofindia.com" in domain or "timesofindia.indiatimes.com" in domain:
        return 5

    if "thehindu.com" in domain:
        return 6
    if "ndtv.com" in domain:
        return 7

    return 0


temp = 0
indToday = id(url)
if indToday == 1:
    temp = 1
index = id(url)

if st.button("Fetch News") and url:
    with st.spinner("Fetching article..."):
        htmlContent = scrape_page(url)
        soup = BeautifulSoup(htmlContent, "html.parser")

        title = fdds.get_Title(soup)
        date = fdds.get_Date(soup)
        author = fdds.get_author(soup)
        desc = fdds.shor_description(soup)
        content = fdds.get_Context(index, soup)
        images = fdds.get_image(index, soup)
        social_links = fdds.get_social_media_Link(temp, soup)

    with st.expander(title):
        st.subheader(f"Title: {title}")
        st.markdown(f"**Date:** {date}")
        st.markdown(f"**Author:** {author}")
        st.markdown(f"**Description:** {desc}")

        st.subheader("Article Content")
        st.write(content)

        if images:
            st.subheader("ðŸ–¼ Images")
            for img in images:
                if img["imgURL"]:
                    st.image(
                        img["imgURL"],
                        caption=img["imgTitle"] or img["imgAlt"],
                        use_column_width=True
                    )

        if social_links:
            st.subheader("ðŸ“º Embedded Media")
            for media in social_links:
                # st.write(media['link'])
                if media["link"]:

                    if media['source'] == 'instagram':
                        st.write("instagram")
                        components.html(
                            f"""
                                <blockquote class="instagram-media"
                                    data-instgrm-permalink="{media['link']}"
                                    data-instgrm-version="14">
                                </blockquote>
                                <script async src="//www.instagram.com/embed.js"></script>
                                """,
                            height=600
                        )
                    if media['source'] == 'reddit':
                        st.write("reddit")
                        components.html(
                            f"""
                                <blockquote class="reddit-embed-bq"
                                    style="height:500px"
                                    data-embed-height="500">
                                <a href="{media['link']}"></a>
                                </blockquote>
                                <script async src="https://embed.reddit.com/widgets.js" charset="UTF-8"></script>
                                """,
                            height=550
                        )
                    if media['source'] == 'twitter':
                        st.write("twitter")
                        components.html(
                            f"""
                                <blockquote class="twitter-tweet">
                                <a href="{media['link']}"></a>
                                </blockquote>
                                <script async src="https://platform.twitter.com/widgets.js"
                                        charset="utf-8"></script>
                                """,
                            height=550
                        )

                    if media['source'] == 'other':
                        st.write("other")
                        components.iframe(
                            src=media["link"],
                            width=400,
                            height=400,
                            scrolling=True
                        )